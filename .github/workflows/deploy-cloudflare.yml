name: ğŸš€ Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: ğŸŒ Deploy TechStep to Cloudflare Pages
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17.0'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --only=production
          echo "âœ… Dependencies installed"

      - name: ğŸ—ï¸ Build project (if needed)
        run: |
          # No build step needed for static HTML
          echo "âœ… Static site ready for deployment"
          ls -la index.html

      - name: ğŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name techstep-platform --compatibility-date 2024-09-15

      - name: ğŸ“Š Deploy Summary
        run: |
          echo "## ğŸ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **TechStep Platform** successfully deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸŒ **Production URL**: https://techstep-platform.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”’ **Custom Domain**: https://www.techstepfoundation.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Features Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Enhanced enrollment experience" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secure Stripe payment integration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Mobile-responsive design" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Advanced security headers" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Performance Benefits:" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ Global CDN (200+ locations)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ DDoS protection & WAF" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ Real-time analytics" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸš€ Edge computing ready" >> $GITHUB_STEP_SUMMARY

  # Preview deployment for pull requests
  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: ğŸ‘ï¸ Preview Deployment
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name techstep-platform --compatibility-date 2024-09-15

      - name: ğŸ’¬ Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://pr-${prNumber}.techstep-platform.pages.dev`;
            
            const comment = `## ğŸ‘ï¸ Preview Deployment Ready!
            
            ğŸŒ **Preview URL**: ${previewUrl}
            
            ### ğŸ§ª Test the enrollment experience:
            - âœ… Course dropdown functionality
            - âœ… Add to Cart system  
            - âœ… Payment options (Stripe integration)
            - âœ… Mobile responsiveness
            - âœ… Terms of Service modals
            
            This preview will be updated automatically with each commit to this PR.`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });