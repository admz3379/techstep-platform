name: 🚀 Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: 🌐 Deploy TechStep to Cloudflare Pages
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.17.0'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: |
          npm ci --only=production
          echo "✅ Dependencies installed"

      - name: 🏗️ Build project (if needed)
        run: |
          # No build step needed for static HTML
          echo "✅ Static site ready for deployment"
          ls -la index.html

      - name: 🚀 Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name techstep-platform --compatibility-date 2024-09-15

      - name: 📊 Deploy Summary
        run: |
          echo "## 🎉 Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **TechStep Platform** successfully deployed to Cloudflare Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🌐 **Production URL**: https://techstep-platform.pages.dev" >> $GITHUB_STEP_SUMMARY
          echo "🔒 **Custom Domain**: https://www.techstepfoundation.org" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Features Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Enhanced enrollment experience" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Secure Stripe payment integration" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Mobile-responsive design" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Advanced security headers" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Performance optimization" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Performance Benefits:" >> $GITHUB_STEP_SUMMARY
          echo "- ⚡ Global CDN (200+ locations)" >> $GITHUB_STEP_SUMMARY
          echo "- 🔒 DDoS protection & WAF" >> $GITHUB_STEP_SUMMARY
          echo "- 📈 Real-time analytics" >> $GITHUB_STEP_SUMMARY
          echo "- 🚀 Edge computing ready" >> $GITHUB_STEP_SUMMARY

  # Preview deployment for pull requests
  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: 👁️ Preview Deployment
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🚀 Deploy Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy . --project-name techstep-platform --compatibility-date 2024-09-15

      - name: 💬 Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const previewUrl = `https://pr-${prNumber}.techstep-platform.pages.dev`;
            
            const comment = `## 👁️ Preview Deployment Ready!
            
            🌐 **Preview URL**: ${previewUrl}
            
            ### 🧪 Test the enrollment experience:
            - ✅ Course dropdown functionality
            - ✅ Add to Cart system  
            - ✅ Payment options (Stripe integration)
            - ✅ Mobile responsiveness
            - ✅ Terms of Service modals
            
            This preview will be updated automatically with each commit to this PR.`;
            
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });